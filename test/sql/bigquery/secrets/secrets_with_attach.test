# name: test/sql/bigquery/secrets/secrets_with_attach_operations.test
# description: Test BigQuery secrets with attached database operations (CREATE TABLE, INSERT, SELECT, billing_project)
# group: [secrets]

require bigquery

require-env BQ_TEST_PROJECT

require-env BQ_TEST_DATASET

require-env BQ_TEST_SA_KEY_PATH

statement ok
CREATE SECRET bq_attach_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://${BQ_TEST_PROJECT}',
    SERVICE_ACCOUNT_PATH '${BQ_TEST_SA_KEY_PATH}'
);

statement ok
ATTACH 'project=${BQ_TEST_PROJECT} dataset=${BQ_TEST_DATASET}' AS bq_test (TYPE bigquery);

statement ok
CREATE OR REPLACE TABLE bq_test.secret_ops_test (
    id INT64,
    name STRING,
    value DOUBLE
);

statement ok
INSERT INTO bq_test.secret_ops_test VALUES
    (1, 'Alice', 100.5),
    (2, 'Bob', 200.75),
    (3, 'Charlie', 300.25);

query III
SELECT * FROM bq_test.secret_ops_test ORDER BY id;
----
1	Alice	100.5
2	Bob	200.75
3	Charlie	300.25

statement ok
DROP TABLE IF EXISTS bq_test.secret_ops_test;

statement ok
DROP SECRET bq_attach_secret;
