# name: test/sql/bigquery/secrets/secrets_with_functions.test
# description: Test BigQuery secrets with bigquery_* functions
# group: [secrets]

require bigquery

require-env BQ_TEST_PROJECT

require-env BQ_TEST_DATASET

require-env BQ_TEST_SA_KEY_PATH

statement ok
CREATE SECRET bq_test_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://${BQ_TEST_PROJECT}',
    SERVICE_ACCOUNT_PATH '${BQ_TEST_SA_KEY_PATH}'
);

statement ok
ATTACH 'project=${BQ_TEST_PROJECT} dataset=${BQ_TEST_DATASET}' AS bq (TYPE bigquery);

# Test bigquery_query with secret
query I
SELECT COUNT(*) FROM bigquery_query('bq', 'SELECT 1 AS num UNION ALL SELECT 2');
----
2

# Test with project_id directly (should use secret)
query I
SELECT COUNT(*) FROM bigquery_query('${BQ_TEST_PROJECT}', 'SELECT 42');
----
1

# Test bigquery_execute with secret
statement ok
SELECT * FROM bigquery_execute('bq', 'DROP TABLE IF EXISTS `${BQ_TEST_PROJECT}.${BQ_TEST_DATASET}.secret_test_table`');

query IIIIIII
SELECT * FROM bigquery_execute('bq', 'CREATE OR REPLACE TABLE `${BQ_TEST_PROJECT}.${BQ_TEST_DATASET}.secret_test_table` (x INT64)');
----
1	<REGEX>:job_.+	<REGEX>:.+	<REGEX>:.+	0	0	0

# Test bigquery_jobs with secret
query I
SELECT COUNT(*) >= 0 FROM bigquery_jobs('bq', maxResults=5);
----
true

# Test bigquery_execute dry_run with secret
query III
FROM bigquery_execute('bq', 'SELECT * FROM `${BQ_TEST_PROJECT}.${BQ_TEST_DATASET}.secret_test_table`', dry_run=true);
----
0	false	<REGEX>:.+

# Cleanup
statement ok
SELECT * FROM bigquery_execute('bq', 'DROP TABLE IF EXISTS `${BQ_TEST_PROJECT}.${BQ_TEST_DATASET}.secret_test_table`');

statement ok
DROP SECRET bq_test_secret;
