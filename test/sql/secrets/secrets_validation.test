# name: test/sql/secrets/secrets_validation.test
# description: Test BigQuery secret validation
# group: [secrets]

require bigquery

statement ok
CREATE SECRET bq_token_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://token-project',
    ACCESS_TOKEN 'ya29.test-access-token-12345'
);

query IIII
SELECT name, type, provider, scope FROM duckdb_secrets() WHERE name = 'bq_token_secret';
----
bq_token_secret	bigquery	config	['bq://token-project']

statement ok
DROP SECRET bq_token_secret;

#################################################################################

statement ok
CREATE SECRET bq_json_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://json-project',
    SERVICE_ACCOUNT_JSON '{"type": "service_account", "project_id": "my-project", "private_key_id": "key123", "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC\n-----END PRIVATE KEY-----\n", "client_email": "test@my-project.iam.gserviceaccount.com", "client_id": "123456789", "auth_uri": "https://accounts.google.com/o/oauth2/auth", "token_uri": "https://oauth2.googleapis.com/token"}'
);

# Verify secret was created
query IIII
SELECT name, type, provider, scope FROM duckdb_secrets() WHERE name = 'bq_json_secret';
----
bq_json_secret	bigquery	config	['bq://json-project']

statement ok
DROP SECRET bq_json_secret;

#################################################################################

# This Key Path doesn't exist
statement error
CREATE SECRET bq_path_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://path-project',
    SERVICE_ACCOUNT_PATH '/this/doesnt/exist.json'
);
----
Invalid Input Error: The 'service_account_path' parameter must be a valid file path (e.g., '/path/to/key.json')

#################################################################################

statement error
CREATE SECRET bq_no_auth_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://no-auth-project'
);
----
Invalid Input Error: BigQuery secret must contain one of: 'access_token', 'service_account_path', 'service_account_json', 'external_account_path', or 'external_account_json'

#################################################################################

statement error
CREATE SECRET bq_multiple_auth_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://multi-project',
    ACCESS_TOKEN 'ya29.test-token',
    SERVICE_ACCOUNT_JSON '{"type": "service_account"}'
);
----
Invalid Input Error: BigQuery secret must contain exactly one authentication method

#################################################################################

statement error
CREATE SECRET bq_path_with_json_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://error-project',
    SERVICE_ACCOUNT_PATH '{"type": "service_account", "project_id": "my-project"}'
);
----
Invalid Input Error: The 'service_account_path' parameter must be a valid file path (e.g., '/path/to/key.json')

#################################################################################

statement error
CREATE SECRET bq_json_with_relative_path_secret (
    TYPE bigquery,
    PROVIDER config,
    SCOPE 'bq://error-project',
    SERVICE_ACCOUNT_JSON './keys/service-account.json'
);
----
Invalid Input Error: The 'service_account_json' parameter must be valid JSON content for service account credentials.
